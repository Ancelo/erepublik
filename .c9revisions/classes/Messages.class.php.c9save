{"ts":1357327054200,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"<?php \r\nif (!class_exists(\"Message\")) {\r\nclass Message\r\n{\r\n\tpublic $id;\r\n\tprivate $qRows=array('id','title','text','timestamp','sender','reciever','last_sender','status');\r\n\t\r\n\t\r\n\tfunction __construct($id=false)\r\n\t{\r\n\t\tif($id){\r\n\t\t\t$this->id=(int)$id;\r\n\t\t}\r\n\t}\r\n\t\r\n\tpublic static function infoMessage($id)\r\n\t{\r\n\t\t$id=(int)$id;\r\n\t\t$query=\"SELECT * FROM messages WHERE id='\".$id.\"' \";\r\n\t\t$result=mysql_query($query,$GLOBALS['db_slave']);\r\n\t\tif(mysql_num_rows($result)<1){ return false;}\r\n\t\t\r\n\t\treturn mysql_fetch_array($result);\r\n\t}\r\n\t\r\n\tpublic function newMessage($array)\r\n\t{\r\n\t\t$arr=array(\r\n\t\t\t'id'=>'',\r\n\t\t\t'status'=>0,\r\n\t\t\t'timestamp'=>time(),\r\n\t\t\t'sender'=>$_SESSION['login']['uid'],\r\n\t\t\t'last_sender'=>$_SESSION['login']['uid']\r\n\t\t);\r\n\t\t$array=array_merge($array,$arr);\r\n\t\t$qSet=parseQuery($array);\r\n\t\tif(!$qSet){die('E1');return false;}\r\n\t\t\r\n\t\t$query=\"INSERT INTO messages SET \".$qSet;\r\n\t\techo $query;\r\n\t\t$result=mysql_query($query,$GLOBALS['db']) or die(mysql_error());\r\n\t\t$done=mysql_affected_rows();\r\n\t\tif($done>0){\r\n\t\t\t$array['id']=mysql_insert_id($GLOBALS['db']);\r\n\t\t\treturn $array;\t\r\n\t\t}\r\n\t\treturn false;\r\n\t}\r\n\tprivate function parseUser($array=false)\r\n\t{\r\n\t\t$qSet=\"\";\r\n\t\tforeach($this->qRows as $row)\r\n\t\t{\t\r\n\t\t\tif(!$array){\r\n\t\t\t\t$content=mysql_real_escape_string(strip_tags($this->$row));\r\n\t\t\t}else{\r\n\t\t\t\t$content=mysql_real_escape_string(strip_tags($array[$row]));\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif($content=='' && ($array && $row!='uid') || !isset($content)){\r\n\t\t\t\treturn false;\r\n\t\t\t}\r\n\t\t\t$qSet.=$row.\"='\".$content.\"',\";\r\n\t\t}\r\n\t\t$qSet=substr($qSet,0,-1);\r\n\t\treturn $qSet;\r\n\t}\r\n\t\r\n\tpublic function saveMessage()\r\n\t{\r\n\t\t$qSet=$this->parseUser();\r\n\t\t\r\n\t\t$query=\"UPDATE users SET \".$qSet.\" WHERE uid='\".$this->uid.\"'\";\r\n\t\t$result=mysql_query($query,$GLOBALS['db']);\r\n\t}\r\n}}\r\n\r\n\r\n?>"]],"start1":0,"start2":0,"length1":0,"length2":1775}]],"length":1775}
